(() => {
  const $app = document.querySelector("#app");
  const LS = {
    get(k, def){ try{ return JSON.parse(localStorage.getItem(k)) ?? def; }catch{ return def; } },
    set(k, v){ localStorage.setItem(k, JSON.stringify(v)); }
  };

  const DATA = () => window.APP_DATA;

  // Keys
  const KEY = {
    stars: "aib7_m1_l1_stars",
    done:  "aib7_m1_l1_done", // {exerciseId:true}
    seen:  "aib7_m1_l1_seen"  // {wordId:true}
  };

  const state = {
    screen: "menu", // menu | lesson | exercise
    exTab: "guess", // guess | match | missing | listen | sentence | reading
    wordIndex: 0,
  };

  function addStars(n){
    const cur = LS.get(KEY.stars, 0);
    LS.set(KEY.stars, cur + n);
    render();
  }
  function stars(){ return LS.get(KEY.stars, 0); }

  function markDone(id){
    const d = LS.get(KEY.done, {});
    d[id] = true;
    LS.set(KEY.done, d);
  }
  function isDone(id){
    const d = LS.get(KEY.done, {});
    return !!d[id];
  }

  function markSeen(wordId){
    const s = LS.get(KEY.seen, {});
    if(!s[wordId]){
      s[wordId] = true;
      LS.set(KEY.seen, s);
      addStars(1); // ‚≠ê –∑–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä
    }
  }

  function speak(text){
    try{
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "en-US";
      u.rate = 0.95;
      speechSynthesis.cancel();
      speechSynthesis.speak(u);
    }catch(e){}
  }

  function resetAll(){
    localStorage.removeItem(KEY.stars);
    localStorage.removeItem(KEY.done);
    localStorage.removeItem(KEY.seen);
    render();
  }

  // -------- UI builders ----------
  function TopBar(){
    const d = DATA();
    return `
      <div class="topbar">
        <div class="toprow">
          <div class="brand">
            <img src="logo.png" alt="logo" onerror="this.style.display='none'">
            <div>
              <h1>${d.appTitle}</h1>
              <small>${d.moduleTitle} ¬∑ ${d.lessonTitle}</small>
            </div>
          </div>
          <div class="actions">
            <button class="btn" data-act="menu">üè† –ú–µ–Ω—é</button>
            <button class="btn" data-act="print">üñ®Ô∏è Print</button>
            <button class="btn primary">‚≠ê <span id="stars">${stars()}</span></button>
            <button class="btn danger" data-act="reset">–°–±—Ä–æ—Å</button>
          </div>
        </div>
      </div>
    `;
  }

  function Menu(){
    return `
      <div class="wrap">
        <div class="grid">
          <div class="card">
            <div class="hd">
              <div>
                <div class="h2">Lesson 1 ¬∑ Indoor hobbies</div>
                <div class="muted">–í–∏–∑—É–∞–ª—å–Ω—ã–π —Å–ª–æ–≤–∞—Ä—å + —Ç—Ä–µ–Ω–∞–∂—ë—Ä—ã ¬∑ 1 –ø–æ–ø—ã—Ç–∫–∞ –≤ –∫–∞–∂–¥–æ–º –∑–∞–¥–∞–Ω–∏–∏</div>
              </div>
              <span class="badge">Module 1</span>
            </div>
            <div class="bd">
              <div class="list">
                <div class="q">
                  <div class="qtop">
                    <b>–ß—Ç–æ –≤–Ω—É—Ç—Ä–∏ —É—Ä–æ–∫–∞</b>
                    <span class="badge">12 words</span>
                  </div>
                  <div class="muted" style="margin-top:8px">
                    Vocabulary ‚Üí Guess ‚Üí Matching ‚Üí Missing letters ‚Üí Listen & type ‚Üí Sentence ‚Üí Reading (T/F)
                  </div>
                </div>
                <button class="btn primary" data-act="openLesson">‚ñ∂Ô∏è –û—Ç–∫—Ä—ã—Ç—å —É—Ä–æ–∫</button>
                <button class="btn" data-act="chat">üí¨ Chat AI Bayan (—Å–∫–æ—Ä–æ)</button>
              </div>
              <div class="footer">
                <div>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ‚≠ê –≤ —Ç–µ–ª–µ—Ñ–æ–Ω–µ (localStorage)</div>
                <div>AI Bayan ¬∑ Grade 7</div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="hd">
              <div class="h2">–ë—ã—Å—Ç—Ä—ã–µ –∫–Ω–æ–ø–∫–∏</div>
              <span class="badge">Trainer</span>
            </div>
            <div class="bd">
              <div class="list">
                <button class="btn" data-act="jump" data-tab="guess">üß† Guess the word</button>
                <button class="btn" data-act="jump" data-tab="match">üß© Matching</button>
                <button class="btn" data-act="jump" data-tab="missing">‚úçÔ∏è Missing letters</button>
                <button class="btn" data-act="jump" data-tab="listen">üéß Listen & type</button>
                <button class="btn" data-act="jump" data-tab="sentence">üìù Sentence</button>
                <button class="btn" data-act="jump" data-tab="reading">üìñ Reading T/F</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  function Lesson(){
    const d = DATA();
    const w = d.words[state.wordIndex];
    // –æ—Ç–º–µ—á–∞–µ–º –ø—Ä–æ—Å–º–æ—Ç—Ä —Å–ª–æ–≤–∞ (–¥–∞—ë—Ç ‚≠ê —Ç–æ–ª—å–∫–æ 1 —Ä–∞–∑ –Ω–∞ —Å–ª–æ–≤–æ)
    setTimeout(() => markSeen(w.id), 0);

    return `
      <div class="wrap">
        <div class="grid">
          <div class="card">
            <div class="hd">
              <div class="h2">üìö Visual Vocabulary</div>
              <span class="badge">${state.wordIndex + 1} / ${d.words.length}</span>
            </div>
            <div class="bd">
              <div class="wordCard">
                <div class="pic" aria-label="image">${w.emoji}</div>
                <div>
                  <div class="wordMain">
                    <div>
                      <b>${w.en}</b>
                      <div class="ru">${w.ru}</div>
                    </div>
                    <div class="smallrow">
                      <button class="btn" data-act="speak" data-text="${escapeAttr(w.en)}">üîä</button>
                    </div>
                  </div>
                  <div class="example">Example: ${w.ex}</div>
                  <div class="smallrow">
                    <button class="btn" data-act="prevWord">‚¨ÖÔ∏è</button>
                    <button class="btn" data-act="nextWord">‚û°Ô∏è</button>
                    <button class="btn primary" data-act="openTrainer">üß† –¢—Ä–µ–Ω–∞–∂—ë—Ä</button>
                  </div>
                  <div class="muted" style="margin-top:10px">
                    ‚≠ê –ó–∞ –ø–µ—Ä–≤—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –∫–∞–∂–¥–æ–≥–æ —Å–ª–æ–≤–∞: +1
                  </div>
                </div>
              </div>

              <div class="hr"></div>

              <div class="muted">
                –°–æ–≤–µ—Ç: –Ω–∞–∂–º–∏ üîä, –ø–æ–≤—Ç–æ—Ä–∏ 2 —Ä–∞–∑–∞, –ø–æ—Ç–æ–º –ø–µ—Ä–µ—Ö–æ–¥–∏ –≤ —Ç—Ä–µ–Ω–∞–∂—ë—Ä.
              </div>
            </div>
          </div>

          ${TrainerTabs()}
        </div>
      </div>
    `;
  }

  function TrainerTabs(){
    const tabs = [
      ["guess","Guess"],
      ["match","Matching"],
      ["missing","Missing"],
      ["listen","Listen"],
      ["sentence","Sentence"],
      ["reading","Reading"],
    ];
    return `
      <div class="card">
        <div class="hd">
          <div class="h2">üß† Trainer</div>
          <span class="badge">1 attempt</span>
        </div>
        <div class="bd">
          <div class="smallrow">
            ${tabs.map(([id,label])=>`
              <button class="btn ${state.exTab===id?'primary':''}" data-act="tab" data-tab="${id}">
                ${label}
              </button>
            `).join("")}
          </div>
          <div class="hr"></div>
          ${renderExercise()}
        </div>
      </div>
    `;
  }

  function renderExercise(){
    switch(state.exTab){
      case "guess": return exGuess();
      case "match": return exMatch();
      case "missing": return exMissing();
      case "listen": return exListen();
      case "sentence": return exSentence();
      case "reading": return exReading();
      default: return `<div class="muted">–í—ã–±–µ—Ä–∏—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ.</div>`;
    }
  }

  // ----- Exercises -----
  function exGuess(){
    const d = DATA();
    return d.exercises.guess.map(q=>{
      const done = isDone(q.id);
      const correct = q.options[0]; // first option may not be correct; we need actual answer from wordId
      const ans = d.words.find(x=>x.id===q.wordId).en;
      const opts = shuffle([...q.options]);
      return `
        <div class="q" data-q="${q.id}">
          <div class="qtop">
            <b>Guess the word</b>
            <span class="badge">${done ? "locked" : "+1 ‚≠ê"}</span>
          </div>
          <div class="muted" style="margin-top:6px">–í—ã–±–µ—Ä–∏ —Å–ª–æ–≤–æ –ø–æ –∫–∞—Ä—Ç–∏–Ω–∫–µ:</div>
          <div class="pic" style="margin-top:10px;width:100%;height:90px;font-size:42px">
            ${d.words.find(x=>x.id===q.wordId).emoji}
          </div>
          <div class="opt">
            ${opts.map(o=>`
              <button class="choice" data-act="answerGuess" data-id="${q.id}" data-ans="${escapeAttr(ans)}" data-pick="${escapeAttr(o)}" ${done?'disabled':''}>
                ${o}
              </button>
            `).join("")}
          </div>
          <div class="result" id="res_${q.id}"></div>
        </div>
      `;
    }).join("");
  }

  function exMatch(){
    const d = DATA();
    const exId = "match1";
    const done = isDone(exId);
    const left = shuffle(d.words.map(w=>({id:w.id, label:`${w.emoji} ${w.en}`})));
    const right = shuffle(d.words.map(w=>({id:w.id, label:w.ru})));

    return `
      <div class="q">
        <div class="qtop">
          <b>Matching (word ‚Üî translation)</b>
          <span class="badge">${done ? "locked" : "+2 ‚≠ê"}</span>
        </div>
        <div class="muted" style="margin-top:6px">–í—ã–±–µ—Ä–∏ –ø–µ—Ä–µ–≤–æ–¥ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–ª–æ–≤–∞ (1 –ø–æ–ø—ã—Ç–∫–∞ –Ω–∞ –≤—Å—é —Ç–∞–±–ª–∏—Ü—É).</div>

        <div class="hr"></div>

        <div class="list" style="gap:8px">
          ${left.map((L,i)=>`
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;align-items:center">
              <div class="choice" style="cursor:default">${L.label}</div>
              <select class="input" data-mid="${L.id}" ${done?'disabled':''}>
                <option value="">‚Äî choose ‚Äî</option>
                ${right.map(R=>`<option value="${R.id}">${R.label}</option>`).join("")}
              </select>
            </div>
          `).join("")}
        </div>

        <div class="smallrow" style="margin-top:12px">
          <button class="btn primary" data-act="checkMatch" ${done?'disabled':''}>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
        </div>
        <div class="result" id="res_match1"></div>
      </div>
    `;
  }

  function exMissing(){
    const d = DATA();
    return d.exercises.missing.map(q=>{
      const done = isDone(q.id);
      return `
        <div class="q">
          <div class="qtop">
            <b>Missing letters</b>
            <span class="badge">${done ? "locked" : "+1 ‚≠ê"}</span>
          </div>
          <div class="muted" style="margin-top:6px">${q.prompt}</div>

          <input class="input" placeholder="type the answer..." data-mid="${q.id}" ${done?'disabled':''} />

          <div class="smallrow">
            <button class="btn" data-act="speak" data-text="${escapeAttr(q.answer)}">üîä</button>
            <button class="btn primary" data-act="checkMissing" data-id="${q.id}" data-ans="${escapeAttr(q.answer)}" ${done?'disabled':''}>Check</button>
          </div>
          <div class="result" id="res_${q.id}"></div>
        </div>
      `;
    }).join("");
  }

  function exListen(){
    const d = DATA();
    // —ç–∫—Ä–∞–Ω–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ (–ø—Ä–æ—Å—Ç–∞—è)
    const letters = "abcdefghijklmnopqrstuvwxyz".split("");
    return d.exercises.listenType.map(q=>{
      const done = isDone(q.id);
      return `
        <div class="q">
          <div class="qtop">
            <b>Listen & type</b>
            <span class="badge">${done ? "locked" : "+2 ‚≠ê"}</span>
          </div>
          <div class="muted" style="margin-top:6px">–ù–∞–∂–º–∏ üîä, –∑–∞—Ç–µ–º –Ω–∞–ø–∏—à–∏ —Å–ª–æ–≤–æ. 1 –ø–æ–ø—ã—Ç–∫–∞.</div>

          <div class="smallrow">
            <button class="btn" data-act="speak" data-text="${escapeAttr(q.answer)}">üîä</button>
          </div>

          <input class="input" data-lid="${q.id}" placeholder="type here..." ${done?'disabled':''}/>

          <div class="kbd" data-kbd="${q.id}">
            ${letters.map(ch=>`<div class="key" data-act="kbd" data-target="${q.id}" data-ch="${ch}" ${done?'style="opacity:.5;pointer-events:none"':''}>${ch}</div>`).join("")}
            <div class="key" data-act="bksp" data-target="${q.id}">‚å´</div>
            <div class="key" data-act="space" data-target="${q.id}">‚ê£</div>
            <div class="key" data-act="clear" data-target="${q.id}">CLR</div>
          </div>

          <div class="smallrow">
            <button class="btn primary" data-act="checkListen" data-id="${q.id}" data-ans="${escapeAttr(q.answer)}" ${done?'disabled':''}>Check</button>
          </div>
          <div class="result" id="res_${q.id}"></div>
        </div>
      `;
    }).join("");
  }

  function exSentence(){
    const d = DATA();
    return d.exercises.sentence.map(q=>{
      const done = isDone(q.id);
      return `
        <div class="q">
          <div class="qtop">
            <b>Word in sentence</b>
            <span class="badge">${done ? "locked" : "+1 ‚≠ê"}</span>
          </div>
          <div style="margin-top:8px;font-weight:900">${q.text}</div>
          <div class="opt">
            ${q.options.map(o=>`
              <button class="choice" data-act="answerSentence" data-id="${q.id}" data-ans="${escapeAttr(q.answer)}" data-pick="${escapeAttr(o)}" ${done?'disabled':''}>
                ${o}
              </button>
            `).join("")}
          </div>
          <div class="result" id="res_${q.id}"></div>
        </div>
      `;
    }).join("");
  }

  function exReading(){
    const d = DATA();
    const exId = "reading1";
    const done = isDone(exId);
    return `
      <div class="q">
        <div class="qtop">
          <b>Mini Reading</b>
          <span class="badge">${done ? "locked" : "+2 ‚≠ê"}</span>
        </div>

        <div class="muted" style="margin-top:8px">${d.exercises.reading.text}</div>

        <div class="hr"></div>

        ${d.exercises.reading.tf.map(t=>`
          <div style="margin-top:10px">
            <div style="font-weight:900">${t.statement}</div>
            <div class="smallrow" style="margin-top:8px">
              <button class="choice" style="width:120px" data-act="tf" data-ex="${exId}" data-id="${t.id}" data-ans="${t.answer}" data-pick="true" ${done?'disabled':''}>True</button>
              <button class="choice" style="width:120px" data-act="tf" data-ex="${exId}" data-id="${t.id}" data-ans="${t.answer}" data-pick="false" ${done?'disabled':''}>False</button>
            </div>
            <div class="result" id="res_${t.id}"></div>
          </div>
        `).join("")}

        <div class="smallrow" style="margin-top:12px">
          <button class="btn primary" data-act="finishReading" ${done?'disabled':''}>Finish</button>
        </div>
        <div class="result" id="res_reading1"></div>
      </div>
    `;
  }

  // -------- Helpers ----------
  function shuffle(arr){
    for(let i=arr.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]]=[arr[j],arr[i]];
    }
    return arr;
  }
  function escapeAttr(s){
    return String(s).replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  // -------- Events ----------
  document.addEventListener("click", (e)=>{
    const btn = e.target.closest("[data-act]");
    if(!btn) return;
    const act = btn.dataset.act;

    if(act==="menu"){ state.screen="menu"; render(); }
    if(act==="openLesson"){ state.screen="lesson"; render(); }
    if(act==="openTrainer"){ state.screen="lesson"; state.exTab="guess"; render(); }
    if(act==="jump"){ state.screen="lesson"; state.exTab=btn.dataset.tab; render(); }
    if(act==="tab"){ state.exTab=btn.dataset.tab; render(); }

    if(act==="prevWord"){
      const d = DATA();
      state.wordIndex = (state.wordIndex - 1 + d.words.length) % d.words.length;
      render();
    }
    if(act==="nextWord"){
      const d = DATA();
      state.wordIndex = (state.wordIndex + 1) % d.words.length;
      render();
    }

    if(act==="speak"){ speak(btn.dataset.text || ""); }

    if(act==="reset"){ resetAll(); }

    if(act==="print"){
      const w = DATA().watermark;
      const wm = document.createElement("div");
      wm.className = "watermark";
      wm.textContent = w;
      document.body.appendChild(wm);
      window.print();
      setTimeout(()=>wm.remove(), 500);
    }

    if(act==="chat"){
      alert("–ß–∞—Ç AI Bayan –ø–æ–¥–∫–ª—é—á–∏–º –ø–æ–∑–∂–µ (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å API). –°–µ–π—á–∞—Å –≥–æ—Ç–æ–≤ —Å–ª–æ–≤–∞—Ä—å –∏ —Ç—Ä–µ–Ω–∞–∂—ë—Ä—ã ‚úÖ");
    }

    // ---- Guess ----
    if(act==="answerGuess"){
      const id = btn.dataset.id;
      if(isDone(id)) return;

      const ans = (btn.dataset.ans||"").trim().toLowerCase();
      const pick = (btn.dataset.pick||"").trim().toLowerCase();
      const res = document.getElementById("res_"+id);

      markDone(id);

      if(pick===ans){
        res.innerHTML = `<span class="ok">‚úî –ü—Ä–∞–≤–∏–ª—å–Ω–æ</span> <span class="starBurst">‚≠ê</span>`;
        addStars(1);
      }else{
        res.innerHTML = `<span class="no">‚úñ –ù–µ–≤–µ—Ä–Ω–æ</span> <span class="muted">(${btn.dataset.ans})</span>`;
      }
      render();
    }

    // ---- Matching ----
    if(act==="checkMatch"){
      const exId = "match1";
      if(isDone(exId)) return;

      const selects = Array.from(document.querySelectorAll('select[data-mid]'));
      const d = DATA();
      let ok = 0;
      for(const s of selects){
        const mid = s.dataset.mid;
        const chosen = s.value;
        if(chosen && chosen === mid) ok++;
      }
      markDone(exId);
      const res = document.getElementById("res_match1");
      if(ok >= Math.ceil(d.words.length * 0.75)){
        res.innerHTML = `<span class="ok">‚úî –û—Ç–ª–∏—á–Ω–æ: ${ok}/${d.words.length}</span> <span class="starBurst">‚≠ê‚≠ê</span>`;
        addStars(2);
      }else{
        res.innerHTML = `<span class="no">‚úñ ${ok}/${d.words.length}</span> <span class="muted">–ù—É–∂–Ω–æ 75%+ –¥–ª—è ‚≠ê‚≠ê</span>`;
      }
      render();
    }

    // ---- Missing ----
    if(act==="checkMissing"){
      const id = btn.dataset.id;
      if(isDone(id)) return;

      const ans = (btn.dataset.ans||"").trim().toLowerCase();
      const inp = document.querySelector(`input[data-mid="${id}"]`);
      const pick = (inp?.value||"").trim().toLowerCase();
      const res = document.getElementById("res_"+id);

      markDone(id);

      if(pick===ans){
        res.innerHTML = `<span class="ok">‚úî –ü—Ä–∞–≤–∏–ª—å–Ω–æ</span> <span class="starBurst">‚≠ê</span>`;
        addStars(1);
      }else{
        res.innerHTML = `<span class="no">‚úñ –ù–µ–≤–µ—Ä–Ω–æ</span> <span class="muted">(${btn.dataset.ans})</span>`;
      }
      render();
    }

    // ---- Listen keyboard ----
    if(act==="kbd" || act==="bksp" || act==="space" || act==="clear"){
      const target = btn.dataset.target;
      const inp = document.querySelector(`input[data-lid="${target}"]`);
      if(!inp || inp.disabled) return;

      if(act==="kbd") inp.value += (btn.dataset.ch || "");
      if(act==="space") inp.value += " ";
      if(act==="bksp") inp.value = inp.value.slice(0,-1);
      if(act==="clear") inp.value = "";
      inp.focus();
    }

    if(act==="checkListen"){
      const id = btn.dataset.id;
      if(isDone(id)) return;

      const ans = (btn.dataset.ans||"").trim().toLowerCase();
      const inp = document.querySelector(`input[data-lid="${id}"]`);
      const pick = (inp?.value||"").trim().toLowerCase();
      const res = document.getElementById("res_"+id);

      markDone(id);

      if(pick===ans){
        res.innerHTML = `<span class="ok">‚úî –ü—Ä–∞–≤–∏–ª—å–Ω–æ</span> <span class="starBurst">‚≠ê‚≠ê</span>`;
        addStars(2);
      }else{
        res.innerHTML = `<span class="no">‚úñ –ù–µ–≤–µ—Ä–Ω–æ</span> <span class="muted">(${btn.dataset.ans})</span>`;
      }
      render();
    }

    // ---- Sentence ----
    if(act==="answerSentence"){
      const id = btn.dataset.id;
      if(isDone(id)) return;

      const ans = (btn.dataset.ans||"").trim().toLowerCase();
      const pick = (btn.dataset.pick||"").trim().toLowerCase();
      const res = document.getElementById("res_"+id);

      markDone(id);

      if(pick===ans){
        res.innerHTML = `<span class="ok">‚úî –ü—Ä–∞–≤–∏–ª—å–Ω–æ</span> <span class="starBurst">‚≠ê</span>`;
        addStars(1);
      }else{
        res.innerHTML = `<span class="no">‚úñ –ù–µ–≤–µ—Ä–Ω–æ</span> <span class="muted">(${btn.dataset.ans})</span>`;
      }
      render();
    }

    // ---- Reading T/F ----
    if(act==="tf"){
      const ex = btn.dataset.ex; // reading1
      if(isDone(ex)) return;     // –µ—Å–ª–∏ –≤–µ—Å—å reading –∑–∞–∫—Ä—ã—Ç ‚Äî –Ω–µ –æ—Ç–≤–µ—á–∞–µ–º

      const id = btn.dataset.id;
      const ans = btn.dataset.ans === "true";
      const pick = btn.dataset.pick === "true";
      const res = document.getElementById("res_"+id);

      // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç—ã –æ—Ç–¥–µ–ª—å–Ω–æ (–Ω–æ –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º –≤–µ—Å—å reading –ø–æ–∫–∞ Finish)
      const tempKey = "aib7_reading_temp";
      const temp = LS.get(tempKey, {});
      temp[id] = (pick === ans);
      LS.set(tempKey, temp);

      if(pick === ans){
        res.innerHTML = `<span class="ok">‚úî</span>`;
      }else{
        res.innerHTML = `<span class="no">‚úñ</span>`;
      }
    }

    if(act==="finishReading"){
      const exId = "reading1";
      if(isDone(exId)) return;

      const tempKey = "aib7_reading_temp";
      const temp = LS.get(tempKey, {});
      const d = DATA();
      const total = d.exercises.reading.tf.length;
      const ok = d.exercises.reading.tf.filter(t=>temp[t.id]===true).length;

      markDone(exId);
      const res = document.getElementById("res_reading1");

      if(ok === total){
        res.innerHTML = `<span class="ok">‚úî –û—Ç–ª–∏—á–Ω–æ: ${ok}/${total}</span> <span class="starBurst">‚≠ê‚≠ê</span>`;
        addStars(2);
      }else{
        res.innerHTML = `<span class="no">‚úñ ${ok}/${total}</span> <span class="muted">–ù—É–∂–Ω–æ –≤—Å—ë –≤–µ—Ä–Ω–æ –¥–ª—è ‚≠ê‚≠ê</span>`;
      }
      localStorage.removeItem(tempKey);
      render();
    }

  });

  // -------- Render ----------
  function render(){
    $app.innerHTML = `
      ${TopBar()}
      ${state.screen==="menu" ? Menu() : Lesson()}
    `;
    const el = document.getElementById("stars");
    if(el) el.textContent = stars();
  }

  // start
  render();
})();
